<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>JuliCash - Remesas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#24fce6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="pantalla active" id="pantalla-dashboard">
            <div class="tarjeta" style="margin-top:34px;">
                <h1 style="margin-bottom: 9px;">JuliCash</h1>
                <div id="theme-toggle-icon" onclick="toggleTheme()">
                <i data-feather="sun"></i>
                </div>
                <h3 id="dash-mes"></h3>
                <div class="kpi"><span class="label">Remesas del mes:</span> <span id="dash-cant"></span></div>
                <div class="kpi"><span class="label">Total recibido:</span> $<span id="dash-recibido"></span></div>
                <div class="kpi"><span class="label">Total entregado:</span> $<span id="dash-entregado"></span></div>
                <div class="kpi important"><span class="label">Ganancia:</span> $<span id="dash-ganancia"></span></div>
                <div class="chart-container">
                    <canvas id="gananciasChart"></canvas>
                </div>
            </div>
        </div>
        <div class="pantalla" id="pantalla-registro">
            <div class="tarjeta">
                <form id="remesaForm" autocomplete="off">
                    <div class="wizard-steps">
                        <div class="step-indicator active" id="indicator-1"></div>
                        <div class="step-indicator" id="indicator-2"></div>
                        <div class="step-indicator" id="indicator-3"></div>
                        <div class="step-indicator" id="indicator-4"></div>
                        <div class="step-indicator" id="indicator-5"></div>
                        <div class="step-indicator" id="indicator-6"></div>
                    </div>
                    <div class="step active" id="step-1">
                        <label>Fecha</label>
                        <input type="date" id="fecha" value="">
                        <div class="wizard-buttons">
                            <button type="button" onclick="nextStep()">Siguiente</button>
                        </div>
                    </div>
                    <div class="step" id="step-2">
                        <label>Envia (quién envía)</label>
                        <input type="text" id="remitente" placeholder="Nombre de quien envía" onblur="actualizarSugerenciasDestinatarios()">
                        <div class="wizard-buttons">
                            <button type="button" onclick="prevStep()">Atrás</button>
                            <button type="button" onclick="nextStep()">Siguiente</button>
                        </div>
                    </div>
                    <div class="step" id="step-3">
                        <label>Monto recibido (USD)</label>
                        <input type="number" id="montoRecibido" min="1" step="0.01" placeholder="Ej: 100">
                        <div class="wizard-buttons">
                            <button type="button" onclick="prevStep()">Atrás</button>
                            <button type="button" onclick="nextStep()">Siguiente</button>
                        </div>
                    </div>
                    <div class="step" id="step-4">
                        <label>Recibe (quién recibe)</label>
                        <input type="text" id="destinatario" placeholder="Nombre de quien recibe" list="destinatarios-sugeridos">
                        <datalist id="destinatarios-sugeridos"></datalist>
                        <div class="wizard-buttons">
                            <button type="button" onclick="prevStep()">Atrás</button>
                            <button type="button" onclick="nextStep()">Siguiente</button>
                        </div>
                    </div>
                    <div class="step" id="step-5">
                        <label>Monto entregado (USD)</label>
                        <input type="number" id="montoEntregado" min="1" step="0.01" placeholder="Ej: 90" oninput="mostrarGanancia()">
                        <div class="ganancia" id="gananciaInfo" style="display:none;"></div>
                        <div class="wizard-buttons">
                            <button type="button" onclick="prevStep()">Atrás</button>
                            <button type="button" onclick="nextStep()">Siguiente</button>
                        </div>
                    </div>
                    <div class="step" id="step-6">
                        <div class="ganancia" id="gananciaFinal"></div>
                        <div class="wizard-buttons" style="justify-content:center">
                            <button type="button" onclick="guardarRemesa()">Guardar remesa</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="pantalla" id="pantalla-historial">
            <div class="tarjeta" style="padding:18px 5px 12px 5px; max-width:390px;">
                <h2 class="titulo-secundario">Historial de Remesas</h2>
                <div style="display:flex;flex-wrap:wrap;gap:6px 8px;align-items:center;justify-content:center;margin-bottom:10px;font-size:0.93rem;">
                    <input type="text" id="filtroRemitente" list="clientesAuto" placeholder="Buscar Envia..." style="width:90px;">
                    <datalist id="clientesAuto"></datalist>
                    <input type="date" id="filtroDesde" style="width:97px;">
                    <input type="date" id="filtroHasta" style="width:97px;">
                    <button class="boton-neon" style="font-size:0.93rem;padding:6px 11px;" onclick="filtrarHistorial()">Buscar</button>
                    <button class="boton-neon boton-neon-sec" style="font-size:0.93rem;padding:6px 11px;" onclick="mostrarUltimas5()">Ver últimas 5</button>
                </div>
                <div id="tablaHistorialCont" style="width:100%;"></div>
            </div>
        </div>
        <div class="pantalla" id="pantalla-clientes">
            <div class="tarjeta">
                <h2>Clientes Frecuentes</h2>
                <ul class="lista-clientes" id="listaClientes"></ul>
            </div>
        </div>
        <div class="pantalla" id="pantalla-conciliacion">
            <div class="tarjeta">
                <h2 class="titulo-secundario">Conciliar remesas</h2>
                <label for="fechaIniC">Desde:</label>
                <input type="date" id="fechaIniC">
                <label for="fechaFinC">Hasta:</label>
                <input type="date" id="fechaFinC">
                <button class="boton-neon" onclick="mostrarTransConciliar()">Buscar</button>
                <div id="transConciliarCont"></div>
                <button class="boton-neon boton-neon-sec" style="margin-top:15px;" onclick="abrirVerConciliaciones()">Ver conciliaciones</button>
            </div>
        </div>
        <div class="pantalla" id="pantalla-ajustes">
            <div class="tarjeta">
                <h2>Gestión de Datos</h2>
                <p class="texto-descriptivo">
    Crea una copia de seguridad de todos tus datos en un archivo, o restaura la aplicación desde una copia anterior.
</p>
                <button class="boton-neon" onclick="exportarDatos()" style="width: 100%; max-width: 280px;">
                    <i data-feather="download"></i>
                    Exportar Copia de Seguridad
                </button>
                <div class="danger-zone">
                    <p style="font-size: 0.9rem; max-width: 300px; color: #ffc0c0; margin-bottom: 10px;">
                        <strong>¡Atención!</strong> Importar un archivo reemplazará TODOS los datos actuales de la aplicación de forma irreversible.
                    </p>
                    <button class="boton-neon boton-neon-sec" onclick="iniciarImportacion()" style="width: 100%; max-width: 280px;">
                         <i data-feather="upload"></i>
                        Importar desde Archivo
                    </button>
                </div>
                    <div class="contacts-zone">
                    <h3 class="titulo-secundario">Gestión de Contactos</h3>
                    <p class="texto-descriptivo">
    Añade o edita los números de teléfono de tus clientes (quienes envían) y sus destinatarios.
</p>
                    <button class="boton-neon" onclick="abrirModalContactos()" style="width: 100%; max-width: 280px;">
                         <i data-feather="book-open"></i>
                        Ver Mis Contactos
                    </button>
                </div>
                <input type="file" id="importadorArchivo" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <div id="modalVerConciliaciones" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-close" onclick="cerrarModalVerConciliaciones()">✖</div>
            <h2 style="color:#fcff64;font-size:1.10rem;margin:0 0 8px 0;">Conciliaciones realizadas</h2>
            <div id="listaConciliacionesCont"></div>
        </div>
    </div>

    <div id="modalContactos" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-close" onclick="cerrarModalContactos()">✖</div>
            <div id="listaContactosCont"></div>
            <div id="detalleContactoCont" style="display:none;"></div>
        </div>
    </div>

    <div class="menu-inferior">
        <div class="menu-btn active" id="menu-dashboard" onclick="renderDashboard(); mostrarPantalla('dashboard')">
            <i data-feather="home"></i>
            <span>Inicio</span>
        </div>
        <div class="menu-btn" id="menu-registro" onclick="mostrarPantalla('registro')">
            <i data-feather="edit-3"></i>
            <span>Remesa</span>
        </div>
        <div class="menu-btn" id="menu-historial" onclick="mostrarUltimas5(); mostrarPantalla('historial')">
            <i data-feather="archive"></i>
            <span>Historial</span>
        </div>
        <div class="menu-btn" id="menu-clientes" onclick="renderClientes(); mostrarPantalla('clientes')">
            <i data-feather="users"></i>
            <span>Clientes</span>
        </div>
        <div class="menu-btn" id="menu-conciliacion" onclick="mostrarPantalla('conciliacion')">
            <i data-feather="check-square"></i>
            <span>Conciliar</span>
        </div>
        <div class="menu-btn" id="menu-ajustes" onclick="mostrarPantalla('ajustes')">
            <i data-feather="settings"></i>
            <span>Ajustes</span>
        </div>
    </div>

    <div id="toast" class="toast">Mensaje</div>

    <script>
        (function() {
    const savedTheme = localStorage.getItem('juli_theme') || 'dark';
    if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
    }
})();
        let historialCardsPage = 1;
        const CARDS_PER_PAGE = 5;
        let historialCardsFiltrado = null;
        let idRemesaEditando = null;
        let myChart = null;

        function mostrarToast(mensaje) {
            const toast = document.getElementById('toast');
            toast.textContent = mensaje;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function exportarDatos() {
            try {
                const datos = {
                    remesas: JSON.parse(localStorage.getItem('juli_remesas') || '[]'),
                    clientes: JSON.parse(localStorage.getItem('juli_clientes') || '[]'),
                    conciliaciones: JSON.parse(localStorage.getItem('juli_conciliaciones') || '[]')
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(datos, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `julicash_backup_${new Date().toISOString().split('T')[0]}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                mostrarToast("Copia de seguridad descargada.");
            } catch (error) {
                console.error("Error al exportar:", error);
                mostrarToast("No se pudieron exportar los datos.");
            }
        }

        function iniciarImportacion() {
            document.getElementById('importadorArchivo').click();
        }

        function importarDesdeArchivo(event) {
            const archivo = event.target.files[0];
            if (!archivo) return;
            if (!confirm('¿Estás realmente seguro?\n\nEsta acción reemplazará TODOS tus datos actuales y no se puede deshacer.')) {
                event.target.value = null;
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);
                    if (datos && typeof datos.remesas === 'object' && typeof datos.clientes === 'object' && typeof datos.conciliaciones === 'object') {
                        localStorage.setItem('juli_remesas', JSON.stringify(datos.remesas));
                        localStorage.setItem('juli_clientes', JSON.stringify(datos.clientes));
                        localStorage.setItem('juli_conciliaciones', JSON.stringify(datos.conciliaciones));
                        mostrarToast('¡Datos importados con éxito! Reiniciando...');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        mostrarToast('Error: El archivo no parece válido.');
                    }
                } catch (error) {
                    console.error("Error al importar el archivo:", error);
                    mostrarToast('Error: El archivo está dañado.');
                } finally {
                    event.target.value = null;
                }
            };
            reader.readAsText(archivo);
        }

        function renderDashboard() {
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            let now = new Date();
            let mes = (now.getMonth() + 1).toString().padStart(2, '0');
            let year = now.getFullYear();
            let nombreMes = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'][now.getMonth()];
            let remesasMes = historial.filter(r => r.fecha && r.fecha.startsWith(`${year}-${mes}`));
            let cant = remesasMes.length;
            let recibido = remesasMes.reduce((s,r)=>s+r.montoRecibido,0);
            let entregado = remesasMes.reduce((s,r)=>s+r.montoEntregado,0);
            let ganancia = remesasMes.reduce((s,r)=>s+r.ganancia,0);
            document.getElementById('dash-mes').textContent = `Mes: ${nombreMes.charAt(0).toUpperCase()+nombreMes.slice(1)} ${year}`;
            document.getElementById('dash-cant').textContent = cant;
            document.getElementById('dash-recibido').textContent = recibido.toFixed(2);
            document.getElementById('dash-entregado').textContent = entregado.toFixed(2);
            document.getElementById('dash-ganancia').textContent = ganancia.toFixed(2);
            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const labels = [];
            const data = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const y = d.getFullYear();
                const m = (d.getMonth() + 1).toString().padStart(2, '0');
                labels.push(meses[d.getMonth()]);
                const gananciaMes = historial
                    .filter(r => r.fecha && r.fecha.startsWith(`${y}-${m}`))
                    .reduce((total, r) => total + r.ganancia, 0);
                data.push(gananciaMes);
            }
            const ctx = document.getElementById('gananciasChart').getContext('2d');
            if (myChart) {
                myChart.destroy();
            }
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ganancia',
                        data: data,
                        backgroundColor: '#24fce640',
                        borderColor: '#24fce6',
                        borderWidth: 1.5,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#191a2c',
                            titleColor: '#24fce6',
                            bodyColor: '#e8f9ff',
                            borderColor: '#24fce680',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#fafbffbb' },
                            grid: { color: '#26ffe620' }
                        },
                        x: {
                            ticks: { color: '#fafbffbb' },
                            grid: { color: 'transparent' }
                        }
                    }
                }
            });
        }

        function renderHistorial(datos = null, append = false) {
            let historial = datos || JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            if (!datos) {
                historialCardsFiltrado = null;
                historial = historial.slice(-CARDS_PER_PAGE * historialCardsPage);
            } else {
                historialCardsFiltrado = historial;
                historial = historial.slice(-(CARDS_PER_PAGE * historialCardsPage));
            }
            if (historial.length === 0) {
                document.getElementById('tablaHistorialCont').innerHTML = "<div style='color:#ccc;text-align:center;margin-top:8px;'>No hay remesas registradas.</div>";
                return;
            }
            let html = "";
            historial.slice().reverse().forEach(rem => {
                html += `<div class="historial-card">
                    ${rem.conciliada ? '<span class="historial-check">✔️</span>' : ''}
                    <div class="fecha">${formatearFecha(rem.fecha)}</div>
                    <div class="historial-row"><span class="historial-label">Envia</span><span>${rem.envia || ''}</span><span class="historial-cantidad">$${rem.montoRecibido !== undefined ? rem.montoRecibido.toFixed(2) : ''}</span></div>
                    <div class="historial-row"><span class="historial-label">Recibe</span><span>${rem.recibe || ''}</span><span class="historial-cantidad">$${rem.montoEntregado !== undefined ? rem.montoEntregado.toFixed(2) : ''}</span></div>
                    <div class="historial-ganancia">Ganancia: $${rem.ganancia !== undefined ? rem.ganancia.toFixed(2) : ''}</div>
                    <div class="historial-acciones">
                        <button class="boton-accion" onclick="iniciarEdicion(${rem.id})">✏️ Editar</button>
                        <button class="boton-accion-eliminar" onclick="eliminarRemesa(${rem.id})">🗑️ Eliminar</button>
                    </div>
                </div>`;
            });
            let totalRemesas = datos ? datos.length : JSON.parse(localStorage.getItem('juli_remesas') || '[]').length;
            let hayMas = (historialCardsPage * CARDS_PER_PAGE) < totalRemesas;
            html += hayMas ? `<button class="boton-neon" style="width:100%;margin-top:5px;" onclick="verMasHistorial()">Ver más</button>` : '';
            document.getElementById('tablaHistorialCont').innerHTML = html;
        }

        function verMasHistorial() {
            historialCardsPage++;
            if (historialCardsFiltrado) {
                renderHistorial(historialCardsFiltrado, true);
            } else {
                renderHistorial();
            }
        }

        function formatearFecha(fecha) {
            if (!fecha) return '';
            let [yy, mm, dd] = fecha.split('-');
            const meses = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
            return `${dd}-${meses[parseInt(mm)-1] || mm}-${yy}`;
        }

        function filtrarHistorial() {
            historialCardsPage = 1;
            let filtroNombre = document.getElementById('filtroRemitente').value.trim();
            let desde = document.getElementById('filtroDesde').value;
            let hasta = document.getElementById('filtroHasta').value;
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            let filtrado = historial.filter(r => {
                let ok = true;
                if (filtroNombre) ok = ok && (r.envia && r.envia.toLowerCase().includes(filtroNombre.toLowerCase()));
                if (desde) ok = ok && (r.fecha && r.fecha >= desde);
                if (hasta) ok = ok && (r.fecha && r.fecha <= hasta);
                return ok;
            });
            renderHistorial(filtrado);
        }

        function mostrarUltimas5() {
            historialCardsPage = 1;
            historialCardsFiltrado = null;
            document.getElementById('filtroRemitente').value = '';
            document.getElementById('filtroDesde').value = '';
            document.getElementById('filtroHasta').value = '';
            renderHistorial();
        }

        let step = 1;
        document.getElementById('fecha').valueAsDate = new Date();
        function showStep() {
            for (let i = 1; i <= 6; i++) document.getElementById('step-' + i).classList.remove('active');
            document.getElementById('step-' + step).classList.add('active');
            for (let i = 1; i <= 6; i++) {
                document.getElementById('indicator-' + i).classList.remove('active');
            }
            document.getElementById('indicator-' + step).classList.add('active');
        }
        function nextStep() {
            if (step < 6) { step++; showStep(); if (step === 5) mostrarGanancia(); if (step === 6) mostrarGananciaFinal(); }
        }
        function prevStep() {
            if (step > 1) { step--; showStep(); }
        }
        function mostrarGanancia() {
            const recibido = parseFloat(document.getElementById('montoRecibido').value) || 0;
            const entregado = parseFloat(document.getElementById('montoEntregado').value) || 0;
            const ganancia = recibido - entregado;
            const info = document.getElementById('gananciaInfo');
            if (recibido > 0 && entregado > 0) {
                info.textContent = `Ganancia: $${ganancia.toFixed(2)}`;
                info.style.display = 'block';
            } else {
                info.style.display = 'none';
            }
        }
        function mostrarGananciaFinal() {
            const recibido = parseFloat(document.getElementById('montoRecibido').value) || 0;
            const entregado = parseFloat(document.getElementById('montoEntregado').value) || 0;
            const ganancia = recibido - entregado;
            const info = document.getElementById('gananciaFinal');
            info.textContent = `Ganancia final de la operación: $${ganancia.toFixed(2)}`;
        }

        function guardarRemesa() {
    const fecha = document.getElementById('fecha').value;
    const remitente = document.getElementById('remitente').value.trim();
    const montoRecibido = parseFloat(document.getElementById('montoRecibido').value) || 0;
    const destinatario = document.getElementById('destinatario').value.trim();
    const montoEntregado = parseFloat(document.getElementById('montoEntregado').value) || 0;
    const ganancia = montoRecibido - montoEntregado;

    if (!fecha || !remitente || !destinatario || montoRecibido <= 0 || montoEntregado <= 0) {
        mostrarToast("Completa todos los campos correctamente.");
        return;
    }

    let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
    if (idRemesaEditando !== null) {
        const index = historial.findIndex(r => r.id === idRemesaEditando);
        if (index !== -1) {
            historial[index] = { ...historial[index], fecha, envia: remitente, recibe: destinatario, montoRecibido, montoEntregado, ganancia };
            mostrarToast('¡Remesa actualizada con éxito!');
        }
    } else {
        const remesa = { fecha, envia: remitente, recibe: destinatario, montoRecibido, montoEntregado, ganancia, conciliada: false, id: Date.now() };
        historial.push(remesa);
        mostrarToast('¡Remesa registrada con éxito!');
    }

    localStorage.setItem('juli_remesas', JSON.stringify(historial));
    agregarCliente(remitente);

    idRemesaEditando = null;
    document.querySelector('#step-6 button').textContent = 'Guardar remesa';
    document.getElementById('remesaForm').reset();
    document.getElementById('fecha').valueAsDate = new Date();
    document.getElementById('destinatarios-sugeridos').innerHTML = ''; // <-- LÍNEA AÑADIDA
    
    step = 1;
    showStep(); 
    
    mostrarPantalla('dashboard');
}

        function eliminarRemesa(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta remesa? Esta acción no se puede deshacer.')) {
                return;
            }
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            const nuevoHistorial = historial.filter(remesa => remesa.id !== id);
            localStorage.setItem('juli_remesas', JSON.stringify(nuevoHistorial));
            mostrarToast('Remesa eliminada con éxito.');
            if (historialCardsFiltrado) {
                filtrarHistorial();
            } else {
                renderHistorial();
            }
            renderDashboard();
        }

        function iniciarEdicion(id) {
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            const remesa = historial.find(r => r.id === id);
            if (!remesa) {
                mostrarToast('Error: No se encontró la remesa.');
                return;
            }
            idRemesaEditando = id;
            document.getElementById('fecha').value = remesa.fecha;
            document.getElementById('remitente').value = remesa.envia;
            document.getElementById('montoRecibido').value = remesa.montoRecibido;
            document.getElementById('destinatario').value = remesa.recibe;
            document.getElementById('montoEntregado').value = remesa.montoEntregado;
            document.querySelector('#step-6 button').textContent = 'Actualizar remesa';
            mostrarPantalla('registro');
            step = 1;
            showStep();
        }

        function mostrarPantalla(nombre) {
            document.querySelectorAll('.pantalla').forEach(div => div.classList.remove('active'));
            document.getElementById('pantalla-' + nombre).classList.add('active');
            document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('menu-' + nombre).classList.add('active');
            feather.replace();
        }

        function agregarCliente(nombre) {
            nombre = nombre.trim();
            if (!nombre) return;
            let clientes = JSON.parse(localStorage.getItem('juli_clientes') || '[]');
            const existe = clientes.some(c => c.nombre.toLowerCase() === nombre.toLowerCase());
            if (!existe) {
                clientes.push({ nombre: nombre, telefono: "" });
                localStorage.setItem('juli_clientes', JSON.stringify(clientes));
            }
        }

        function renderClientes() {
            let clientes = JSON.parse(localStorage.getItem('juli_clientes') || '[]').sort((a, b) => a.nombre.localeCompare(b.nombre));
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            if (clientes.length === 0) {
                document.getElementById('listaClientes').innerHTML = "<li style='text-align:center;color:#ccc;'>Aún no hay clientes registrados.</li>";
                return;
            }
            let html = "";
            clientes.forEach(cliente => {
                let remesasCliente = historial.filter(r => r.envia === cliente.nombre);
                html += `<li onclick="verHistorialCliente('${cliente.nombre}')">
                    <span class="label">${cliente.nombre}</span>
                    <span style="color:#fcff64;font-size:0.99rem;">${remesasCliente.length} envíos</span>
                </li>`;
            });
            document.getElementById('listaClientes').innerHTML = html;
        }

        function verHistorialCliente(nombreCliente) {
            document.getElementById('filtroRemitente').value = nombreCliente;
            document.getElementById('filtroDesde').value = '';
            document.getElementById('filtroHasta').value = '';
            filtrarHistorial();
            mostrarPantalla('historial');
        }
        function actualizarSugerenciasDestinatarios() {
    const remitenteNombre = document.getElementById('remitente').value.trim();
    const datalist = document.getElementById('destinatarios-sugeridos');
    
    // Si no hay nombre de remitente, limpiamos la lista y salimos
    if (!remitenteNombre) {
        datalist.innerHTML = '';
        return;
    }

    // Buscamos en el historial las remesas de este cliente
    let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
    let remesasCliente = historial.filter(r => r.envia.toLowerCase() === remitenteNombre.toLowerCase());

    // Creamos una lista única de destinatarios para ese cliente
    let destinatariosUnicos = [...new Set(remesasCliente.map(r => r.recibe.trim()))].sort();

    // Llenamos el datalist con las sugerencias
    let html = "";
    destinatariosUnicos.forEach(dest => {
        html += `<option value="${dest}"></option>`;
    });
    datalist.innerHTML = html;
        }
        function mostrarTransConciliar() {
            let ini = document.getElementById('fechaIniC').value;
            let fin = document.getElementById('fechaFinC').value;
            if (!ini || !fin || ini > fin) {
                document.getElementById('transConciliarCont').innerHTML = "<div style='color:#ff9696;margin:10px 0;'>Selecciona un rango de fechas válido.</div>";
                return;
            }
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            let trans = historial.filter(r => r.fecha >= ini && r.fecha <= fin && !r.conciliada);
            if (trans.length === 0) {
                document.getElementById('transConciliarCont').innerHTML = "<div style='color:#26ffe6;margin:14px 0;'>No hay remesas pendientes en este rango.</div>";
                return;
            }
            let html = `<div style="margin:8px 0 10px 0;font-weight:bold;color:#fcff64;">${trans.length} remesas encontradas</div>`;
            html += `<table class="tabla-historial" style="margin:0 auto;">
                <thead><tr><th>Fecha</th><th>Envia</th><th>Recibe</th><th>Recibido</th><th>Entregado</th></tr></thead><tbody>`;
            trans.forEach(rem => {
                html += `<tr><td>${rem.fecha}</td><td>${rem.envia}</td><td>${rem.recibe}</td><td>$${rem.montoRecibido.toFixed(2)}</td><td>$${rem.montoEntregado.toFixed(2)}</td></tr>`;
            });
            html += `</tbody></table><button class="boton-neon" onclick="conciliarTransacciones('${ini}','${fin}')">Conciliar todas</button>`;
            document.getElementById('transConciliarCont').innerHTML = html;
        }
        function conciliarTransacciones(ini, fin) {
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            let conciliadas = [];
            for (let i = 0; i < historial.length; i++) {
                if (historial[i].fecha >= ini && historial[i].fecha <= fin && !historial[i].conciliada) {
                    historial[i].conciliada = true;
                    conciliadas.push(historial[i].id);
                }
            }
            localStorage.setItem('juli_remesas', JSON.stringify(historial));
            let log = JSON.parse(localStorage.getItem('juli_conciliaciones') || '[]');
            log.push({ fecha: new Date().toISOString(), rango: {ini, fin}, ids: conciliadas, total: conciliadas.length });
            localStorage.setItem('juli_conciliaciones', JSON.stringify(log));
            mostrarToast("¡Remesas conciliadas con éxito!");
            mostrarTransConciliar();
            renderHistorial();
        }
        function abrirVerConciliaciones() {
            document.getElementById('modalVerConciliaciones').style.display = 'flex';
            renderListaConciliaciones();
        }
        function cerrarModalVerConciliaciones() {
            document.getElementById('modalVerConciliaciones').style.display = 'none';
        }
        function renderListaConciliaciones() {
            let log = JSON.parse(localStorage.getItem('juli_conciliaciones') || '[]');
            if (log.length === 0) {
                document.getElementById('listaConciliacionesCont').innerHTML = "<div style='color:#ccc;margin-top:10px;'>No hay conciliaciones registradas.</div>";
                return;
            }
            let html = "<div style='max-height:320px;overflow-y:auto;'>";
            log.slice().reverse().forEach((c,idx) => {
                let fecha = c.fecha.split('T')[0];
                let desde = c.rango.ini;
                let hasta = c.rango.fin;
                html += `<div style="margin-bottom:13px;padding:10px 6px 10px 6px;border-radius:12px;background:#1a2437cc;box-shadow:0 0 12px #2affc555;">
                    <div style="font-weight:bold;color:#26ffe6;margin-bottom:2px;">#${log.length-idx} - Conciliación: ${fecha}</div>
                    <div style="color:#fcff64;">Rango: ${desde} → ${hasta}</div>
                    <div style="color:#baff8a;margin-bottom:7px;">${c.total} remesas conciliadas</div>
                    <button class="boton-neon" style="font-size:0.98rem;padding:5px 13px;" onclick="verDetalleConciliacion('${c.ids.join(',')}')">Ver detalle</button>
                </div>`;
            });
            html += "</div>";
            document.getElementById('listaConciliacionesCont').innerHTML = html;
        }
        function verDetalleConciliacion(ids) {
            let arr = ids.split(',').map(x=>parseInt(x));
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            let trans = historial.filter(r => arr.includes(r.id));
            let html = "<table class='tabla-historial' style='margin:7px auto;'><thead><tr><th>Fecha</th><th>Envia</th><th>Recibe</th><th>Recibido</th><th>Entregado</th></tr></thead><tbody>";
            trans.forEach(rem => {
                html += `<tr><td>${rem.fecha}</td><td>${rem.envia}</td><td>${rem.recibe}</td><td>$${rem.montoRecibido.toFixed(2)}</td><td>$${rem.montoEntregado.toFixed(2)}</td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('listaConciliacionesCont').innerHTML = html + `<button class="boton-neon" style="margin-top:10px;" onclick="renderListaConciliaciones()">Regresar</button>`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('importadorArchivo').addEventListener('change', importarDesdeArchivo);
            renderDashboard(); // Render the dashboard on initial load
            mostrarPantalla('dashboard');
        });

        function abrirModalContactos() {
            renderListaContactos();
            document.getElementById('modalContactos').style.display = 'flex';
            feather.replace();
        }

        function cerrarModalContactos() {
            document.getElementById('modalContactos').style.display = 'none';
            document.getElementById('listaContactosCont').style.display = 'block';
            document.getElementById('detalleContactoCont').style.display = 'none';
            document.getElementById('detalleContactoCont').innerHTML = '';
        }

        function renderListaContactos() {
            let clientes = JSON.parse(localStorage.getItem('juli_clientes') || '[]').sort((a, b) => a.nombre.localeCompare(b.nombre));
            let html = '<h3 style="color:#26ffe6; text-align:center; margin-top:0;">Mis Contactos</h3>';
            if (clientes.length === 0) {
                html += "<div style='color:#ccc;text-align:center;margin-top:15px;'>No hay contactos guardados.</div>";
            } else {
                clientes.forEach(cliente => {
                    html += `<div class="contacto-item" onclick="verDetalleContacto('${cliente.nombre}')">
                        <div class="contacto-nombre">${cliente.nombre}</div>
                        <div style="font-size:0.9rem; color:#fafbffbb;">${cliente.telefono || 'Sin teléfono'}</div>
                    </div>`;
                });
            }
            document.getElementById('listaContactosCont').innerHTML = html;
            document.getElementById('listaContactosCont').style.display = 'block';
            document.getElementById('detalleContactoCont').style.display = 'none';
        }

        function verDetalleContacto(nombreCliente) {
            let clientes = JSON.parse(localStorage.getItem('juli_clientes') || '[]');
            const cliente = clientes.find(c => c.nombre === nombreCliente);
            if (!cliente) return;
            let historial = JSON.parse(localStorage.getItem('juli_remesas') || '[]');
            let remesasCliente = historial.filter(r => r.envia === nombreCliente);
            let destinatariosUnicos = [...new Set(remesasCliente.map(r => r.recibe.trim()))].sort();
            let html = `
                <button class="boton-neon" style="font-size:0.9rem; padding: 4px 10px;" onclick="renderListaContactos()"><i data-feather="arrow-left"></i> Volver</button>
                <div class="detalle-header">
                    <div class="nombre-cliente">${cliente.nombre}</div>
                    <label style="align-self:center;">Teléfono del Cliente</label>
                    <div class="input-group">
                        <input type="tel" id="tel-${cliente.nombre.replace(/\s/g, '')}" value="${cliente.telefono || ''}" placeholder="Añadir teléfono">
                        <button class="boton-neon" style="padding: 7px;" onclick="guardarTelefonoCliente('${cliente.nombre}')"><i data-feather="save"></i></button>
                    </div>
                </div>
                <div class="destinatarios-lista">
                    <h4>Destinatarios Frecuentes</h4>`;
            if (destinatariosUnicos.length > 0) {
                let destinatariosData = JSON.parse(localStorage.getItem(`destinatarios_${cliente.nombre.replace(/\s/g, '')}`) || '{}');
                destinatariosUnicos.forEach(dest => {
                    const telDest = destinatariosData[dest] || '';
                    html += `
                        <div class="destinatario-item">
                            <div class="nombre">${dest}</div>
                            <div class="input-group">
                                <input type="tel" id="tel-${dest.replace(/\s/g, '')}" value="${telDest}" placeholder="Añadir teléfono">
                                <button class="boton-neon" style="padding: 7px;" onclick="guardarTelefonoDestinatario('${cliente.nombre}', '${dest}')"><i data-feather="save"></i></button>
                            </div>
                        </div>`;
                });
            } else {
                html += "<div style='color:#ccc;text-align:center;'>No hay destinatarios registrados para este cliente.</div>";
            }
            html += `</div>`;
            document.getElementById('detalleContactoCont').innerHTML = html;
            document.getElementById('listaContactosCont').style.display = 'none';
            document.getElementById('detalleContactoCont').style.display = 'block';
            feather.replace();
        }

        function guardarTelefonoCliente(nombreCliente) {
            let clientes = JSON.parse(localStorage.getItem('juli_clientes') || '[]');
            const index = clientes.findIndex(c => c.nombre === nombreCliente);
            if (index !== -1) {
                const nuevoTel = document.getElementById(`tel-${nombreCliente.replace(/\s/g, '')}`).value;
                clientes[index].telefono = nuevoTel.trim();
                localStorage.setItem('juli_clientes', JSON.stringify(clientes));
                mostrarToast('Teléfono guardado.');
            }
        }

        function guardarTelefonoDestinatario(nombreCliente, nombreDest) {
            const key = `destinatarios_${nombreCliente.replace(/\s/g, '')}`;
            let destinatariosData = JSON.parse(localStorage.getItem(key) || '{}');
            const nuevoTel = document.getElementById(`tel-${nombreDest.replace(/\s/g, '')}`).value;
            destinatariosData[nombreDest] = nuevoTel.trim();
            localStorage.setItem(key, JSON.stringify(destinatariosData));
            mostrarToast('Teléfono del destinatario guardado.');
        }
function toggleTheme() {
    document.body.classList.toggle('light-theme');
    const theme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
    localStorage.setItem('juli_theme', theme);
    updateThemeIcon(theme);
    feather.replace(); // Actualiza el icono
}

function updateThemeIcon(theme) {
    const iconContainer = document.getElementById('theme-toggle-icon');
    if (iconContainer) { // Solo si el icono existe en la pantalla actual
        if (theme === 'light') {
            iconContainer.innerHTML = '<i data-feather="moon"></i>';
        } else {
            iconContainer.innerHTML = '<i data-feather="sun"></i>';
        }
    }
}
        // Initialize the app
        showStep();
        renderDashboard();
        document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('importadorArchivo').addEventListener('change', importarDesdeArchivo);
    
    // Configurar el tema al cargar
    const currentTheme = localStorage.getItem('juli_theme') || 'dark';
    updateThemeIcon(currentTheme);

    renderDashboard(); // Render the dashboard on initial load
    mostrarPantalla('dashboard');
});
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registrado!', reg))
          .catch(err => console.error('SW error', err));
      }
    </script>
    <script>
      feather.replace();
    </script>
</body>
</html>
